#include <stdio.h>
#include "system.h"
#include "altera_avalon_pio_regs.h"
#include "altera_avalon_timer_regs.h"
#include "sys/alt_irq.h"



volatile int led_state = 0;
volatile int u = 0;
volatile int d = 0;
volatile int c = 0;
volatile int m = 0;

int *h0 = HEX_0_BASE;
int *h1 = HEX_1_BASE;
int *h2 = HEX_2_BASE;
int *h3 = HEX_3_BASE;

void seven_dis(int *p, int n){
	switch(n){
	case 0: *p = 0xFF;
	break;
	case 1: *p = 0x79;
	break;
	case 2: *p = 0x24;
	break;
	case 3:  *p = 0x30;
	break;
	case 4:  *p = 0x19;
	break;
	case 5:  *p = 0x42;
	break;
	case 6:  *p = 0x02;
	break;
	case 7:  *p = 0x78;
	break;
	case 8:  *p = 0x00;
	break;
	case 9:  *p = 0x18;
	break;
	default: break;

}
}

void update_display(){
	seven_dis(h0, u);
	seven_dis(h1, d);
	seven_dis(h2, c);
	seven_dis(h3, m);
}


static void handle_timer_interrupt(void *context)
{

    IOWR_ALTERA_AVALON_TIMER_STATUS(TIMER_0_BASE, 0);

    static int contador_tempo = 0;
    static int contador_seg = 0;
    contador_tempo++;
    contador_seg++;

    if (contador_tempo >= 500)
    {
        led_state = !led_state;

        if (led_state) {
            IOWR_ALTERA_AVALON_PIO_DATA(LEDS_BASE, 0x3FF);
        } else {
            IOWR_ALTERA_AVALON_PIO_DATA(LEDS_BASE, 0x000);
        }

        contador_tempo = 0;
    }
    if (contador_seg >=1000){
    	u++;
    	if(u == 10){
    		u=0;
    		d++;
    		if(d == 10){
    			d++;
    			c++;
    			if(c==10){
    				c=0;
    				m++;
    				if(m==10){
    					m=0;
    					update_display();
    				}
    			}

    		}
    	}
    	update_display();

    }
}




int main()
{
	int *p;
	//*a = 0xFFFFFFFF;


    alt_ic_isr_register(
        TIMER_0_IRQ_INTERRUPT_CONTROLLER_ID,
        TIMER_0_IRQ,
        handle_timer_interrupt,
        NULL,
        NULL
    );



    IOWR_ALTERA_AVALON_TIMER_CONTROL(TIMER_0_BASE,
        ALTERA_AVALON_TIMER_CONTROL_ITO_MSK  |
        ALTERA_AVALON_TIMER_CONTROL_CONT_MSK |
        ALTERA_AVALON_TIMER_CONTROL_START_MSK);

/*
    IOWR_ALTERA_AVALON_PIO_DATA(HEX_0_BASE,0x02); //0100000
    IOWR_ALTERA_AVALON_PIO_DATA(HEX_1_BASE,0x24); //0010010
    IOWR_ALTERA_AVALON_PIO_DATA(HEX_2_BASE,0x40); //0000001
    IOWR_ALTERA_AVALON_PIO_DATA(HEX_3_BASE,0x24); //0010010
    IOWR_ALTERA_AVALON_PIO_DATA(HEX_4_BASE,0xFF); //0000001
    IOWR_ALTERA_AVALON_PIO_DATA(HEX_5_BASE,0xFF); //0010010
    */
    int contagem_main = 0;
    while(1)
    {

    }

    return 0;
}
